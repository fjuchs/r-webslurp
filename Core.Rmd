---
title: "R Notebook"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

```{r}
library(httr)
library(rvest)
library(purrr)
library(stringr)
library(magrittr)
library(dplyr)

# source only if needed
tryCatch(CorporateSourced(), error = function(e) source("Corporate.R"))

```

```{r}
# set sys
Sys.setlocale("LC_TIME","English")

# init table
# not needed, replaced with data load from csv
initPriceTable <-  function() {
  cols <- c("name",
            "date",
            "week",
            "day",
            "fuel",
            "price",
            "week_rank",
            "origin")
  table <- data.frame(matrix(nrow = 0, ncol = length(cols)))
  colnames(table)=cols
  table
}

# load datalog
dataTable <- read.csv("data.csv")
dataTable$X = NULL
dataTable$date %<>% as.Date

# UTILITIES
# get current date
today <- Sys.Date() %>% as.Date

# update into is a closure function
updatePriceInto <- function(table) {
  # as a closure, to check against provided table
  # does not mutate provided table (has to be 'rbind' to include in data)
  function(name, date, fuel, price, origin) {
    tableNow <-  filter(table, table$name==name)
    dataNow <- data.frame(name,
                          date,
                          week = format(date,"%Y/w%W"),
                          day = weekdays(date),
                          fuel,
                          price,
                          week_rank = format(date-1,"%Y%W"),
                          origin)
    
    if (date %in% tableNow$date) { 
      currentPrices <- tableNow %>% filter(.,.$date==date,.$fuel==fuel) %>% .$price
      if (price %in% currentPrices) {
        print(paste("[Warrning] Zaznam jiz existuje:", date,">", fuel, ":", price, "/", origin, "/"))
        NULL
      } else {
        # TODO d-1 zmena....
        print("zmena d-1")
        NULL
      }
    } else {
      print(paste(date, "Nova cena", fuel, ":", price))
      dataNow
    } 
  } 
}

# ADJUST DATA
addMissingData <- function(name, date, fuel, price, origin = "manual_input", export = F) {
  
  missingData <- updatePriceInto(dataTable)
  
  dataTable %<>%  rbind(.,missingData(name,
                                      date,
                                      fuel,
                                      price,
                                      origin))
  dataTable %<>% .[rev(order(.$date)),]
  if (export) dataTable %>% write.csv(.,"data.csv")
  dataTable
}

comment <- function() {
  ## DEV block
  
  addMissingData(name = "AXIGON",
                 date = as.Date("2019-11-26"),
                 fuel = "Diesel",
                 price = 25.28,
                 export = T)
  
  
}
```

## AXIGON
```{r}
URL <- "https://www.axigon.cz"

# check proxy
proxyValidation()

# get page
pg <- read_html(GET(URL))
```

```{r}
# slurp price from web
price <- html_nodes(pg, "div.hero__remark") %>%
  html_text %>%
  str_extract(.,"\\d....") %>%
  str_replace(.,"[,]","\\.") %>% 
  as.double


# update and save
priceUpdate <- updatePriceInto(dataTable)
dataTable %<>% rbind(.,priceUpdate(name = "AXIGON",
                                   date = today,
                                   fuel = "Diesel",
                                   price = price,
                                   origin = "webslurp"))

dataTable %<>% .[rev(order(.$date)),]

dataTable %>% write.csv(.,"data.csv")
dataTable


```

```{r include=FALSE}
comment <- function() {
  # dev block
  
  rm(list = ls())
  dataTable
  
}
```

## ERNEKS
```{r eval=FALSE, include=FALSE}
## ERNEKS
URL <- "http://www.erneks.cz/tankovaci-karta/shell-fix"
proxyValidation()

pg <- read_html(GET(URL))
```

```{r eval=FALSE, include=FALSE}
html_nodes(pg, "div.AREA_advantages")
```

## TANK ONO
```{r}
## Tank ONO
URL <- "http://m.tank-ono.cz/cz/index.php?page=cenik"
pg <- read_html(GET(URL))

```

```{r}
extractDivItems <- function(div) {
  # Creates closure around div class name
  # takes min and max rows index for result
  function(rowMin, rowMax) {
    result <- html_nodes(pg, div) %>%
           html_text %>%
           .[rowMax:rowMin] %>%
           # remove new-line, return, spaces
           gsub("[\r\n ]", "", .) %>% 
           data.frame %>%
           mutate_all(as.character)
    result
  }
}

tonoPrices <- extractDivItems("div.divprice")
tonoGNames <- extractDivItems("div.divprgw")
tonoDNames <- extractDivItems("div.divprbw")

tonoPL <- bind_cols(bind_rows(tonoGNames(1,3),
                                     tonoDNames(1,3)),
                           tonoPrices(1,6))


tonoPL %<>% `colnames<-`(.,c("fuel","price"))
tonoPL$price %<>% as.double
tonoPL$price <-  tonoPL$price / 121
tonoPL$name = "TankOno"
tonoPL$date = today
tonoPL$origin = "webslurp"


# TODO join the main dataTable

tonoPL

```



